# core/maps.py
# -*- coding: utf-8 -*-
"""
ãƒãƒƒãƒ—ã”ã¨ã«IDãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ãƒˆãƒªã‚¬ãƒ¼ãƒ»ãƒ†ã‚¯ã‚¹ãƒãƒ£è¨­å®šã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
å„ãƒãƒƒãƒ—ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚

- '>' ã®ä½ç½®ã¨ triggers(pos) ã‚’å³å¯†ã«ä¸€è‡´ã•ã›ã‚‹ã€‚
- ã©ã®ãƒãƒƒãƒ—ã§ã‚‚ 'D'(ãƒ‰ã‚¢)ãƒ»'X'(å°é–) ã‚’æç”»ã§ãã‚‹ã‚ˆã† wall_special ã«æ¨™æº–æŒ‡å®šã‚’ä»˜ä¸ã€‚
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€ä¸€éƒ¨ "suggested_" ç³»ã®ãƒ’ãƒ³ãƒˆã‚’æ®‹ã—ã¤ã¤ã€å®Ÿéš›ã®é·ç§»ã¯ triggers ã§ç¢ºå®šã€‚

ãƒ†ãƒ¬ãƒãƒ¼ãƒˆã€Œå‘ãã‚»ãƒƒãƒˆã€
triggers ã« "target_face": "N" | "E" | "S" | "W" ã‹ã€ "target_angle": <ãƒ©ã‚¸ã‚¢ãƒ³ or åº¦> ã‚’è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚
ï¼ˆã©ã¡ã‚‰ã‹ç‰‡æ–¹ã ã‘ã§OKã€‚ä¸¡æ–¹ã‚ã‚‹å ´åˆã¯ target_angle ãŒå„ªå…ˆï¼‰
ä¾‹ï¼šãƒ€ãƒ³ã‚¸ãƒ§ãƒ³1 â†’ ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³2ï¼ˆé™ã‚ŠãŸã‚‰å—å‘ãï¼‰
"triggers": [
    {"event": "stair_down", "pos": (15, 1), "target_map": "dungeon_2", "target_pos": (2, 1),
     "target_face": "S",  # â† è¿½åŠ ï¼šå—ï¼ˆä¸‹ï¼‰ã‚’å‘ã„ã¦é–‹å§‹
     "prompt": "ã•ã‚‰ã«åœ°ä¸‹æ·±ãã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
]
è§’åº¦ã§ç›´æŒ‡å®šã—ãŸã„å ´åˆï¼ˆåº¦ã§ã‚‚ãƒ©ã‚¸ã‚¢ãƒ³ã§ã‚‚OKï¼‰
"target_angle": 90      // 90åº¦ï¼ˆè‡ªå‹•ã§ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ï¼‰
"target_angle": 1.5708  // ç´„ Ï€/2 ãƒ©ã‚¸ã‚¢ãƒ³

å‡¡ä¾‹ï¼ˆã‚¿ã‚¤ãƒ«è¨˜å·ï¼‰ï¼š
# = å£, . = åºŠ, > = å‡ºå£(æ¬¡ã‚¨ãƒªã‚¢ã¸), < = å…¥å£(å‰ã‚¨ãƒªã‚¢ã¸)
D = ãƒ‰ã‚¢ï¼ˆè£…é£¾orã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥ç”¨ï¼‰, X = å°é–å£ï¼ˆãƒ‘ã‚ºãƒ«ã§è§£é™¤ï¼‰
P/Q/R/S = çµµç”», a/b/c/d = åºŠã‚¹ã‚¤ãƒƒãƒ
F/M/w/O = æ£®ã®æ¼”å‡ºï¼ˆéœ§,å®ˆäºº,æ°´,å¤§æœ¨ï¼‰â€»å¿…è¦ã«å¿œã˜ã¦ä½¿ç”¨

"""
from __future__ import annotations
from typing import Dict, Tuple, Any, List
from .config import DEV_STRICT_VALIDATION
from .tile_types import TILE_TYPES

MAPS_SCHEMA_VERSION = 2  # ä»Šå¾Œã€ç ´å£Šçš„å¤‰æ›´ã‚’å…¥ã‚Œã‚‹ã¨ãã«ä¸Šã’ã¾ã™ğŸ”¨

def _assert_rectangular(map_id: str, map_def: dict) -> None:
    layout = map_def.get("layout") or []
    if not layout:
        raise ValueError(f"[{map_id}] layoutãŒç©ºã§ã™ã€‚")
    w0 = len(layout[0])
    for y, row in enumerate(layout):
        if len(row) != w0:
            raise ValueError(f"[{map_id}] éçŸ©å½¢ã§ã™: row={y} expected={w0} got={len(row)} -> {row!r}")

def _validate_trigger_vs_layout(map_id: str, map_def: dict) -> List[str]:
    """
    'stair_down' ã¯ '>'ã€'stair_up' ã¯ '<' ã¨ posãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’è¨ºæ–­ã€‚
    åˆã‚ãªã„å ´åˆã¯è­¦å‘Šæ–‡å­—åˆ—ã‚’è¿”ã™ï¼ˆä¾‹å¤–ã¯æŠ•ã’ãªã„ï¼‰ã€‚
    """
    msgs: List[str] = []
    layout: List[str] = map_def.get("layout", [])
    H = len(layout)
    W = len(layout[0]) if H else 0
    for t in map_def.get("triggers", []):
        pos = t.get("pos")
        ev  = t.get("event")
        if not pos or not isinstance(pos, (tuple, list)) or len(pos) != 2:
            msgs.append(f"[{map_id}] trigger posä¸æ­£: {t}")
            continue
        x, y = pos
        if not (0 <= y < H and 0 <= x < W):
            msgs.append(f"[{map_id}] trigger posãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤–: {t}")
            continue
        ch = layout[y][x]
        want = '>' if ev == 'stair_down' else '<' if ev == 'stair_up' else None
        if want and ch != want:
            msgs.append(f"[{map_id}] trigger {ev} ã®åº§æ¨™{pos}ã« '{want}' ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå®Ÿéš›: '{ch}'ï¼‰")
    return msgs

def run_maps_health_check(MAPS: Dict[str, Any]) -> None:
    """
    èµ·å‹•æ™‚ã«ä¸€æ‹¬è¨ºæ–­ã€‚è‡´å‘½çš„ï¼ä¾‹å¤–ã€è»½å¾®ï¼è­¦å‘Šprintã€‚
    """
    for mid, m in MAPS.items():
        _assert_rectangular(mid, m)
        warns = _validate_trigger_vs_layout(mid, m)
        for w in warns:
            print("[WARN]", w)
        # ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚­ãƒ¼ã®æœ€ä½é™ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚Œã°OKï¼‰
        tex = m.get("textures") or {}
        tex.setdefault("wall_special", {})
        tex.setdefault("special", {})

        spec = (m.get("textures", {}).get("special") or {})
        need = set()
        if any('w' in row for row in m.get("layout", [])): need.add('w')
        if any('B' in row for row in m.get("layout", [])): need.add('B')
        missing = [k for k in need if k not in spec]
        if missing:
            print(f"[WARN] {mid}: special ã« {missing} ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå·/æ©‹ã®å®šç¾©æŠœã‘ï¼‰")

    if DEV_STRICT_VALIDATION:
        print("[INFO] MAPS health check complete.")

        
# MAPä¸Šã®â€œä»Šè¦‹ãˆã‚‹ã‚¢ã‚¤ãƒ†ãƒ â€ã‚’åˆ—æŒ™
def iter_visible_items(map_id: str):
    from core.interactions import _normalize_item_entry, make_entity_key
    import core.game_state as game_state
    picked = game_state.FLAGS.get("picked_items", set())
    for raw in MAPS[map_id].get("items", []):
        it = _normalize_item_entry(raw)
        tx, ty = it["tile"]
        uniq = it.get("id") or it["type"]
        key = make_entity_key(map_id, "item", uniq, tx, ty)
        if key in picked:
            continue
        yield it

MAPS = {
    # ============================================================================
    # 1) æ£®ï¼š4ã‚¨ãƒªã‚¢ï¼ˆforest_1â†’_2â†’_3â†’_4ï¼‰
    #     æœ€çµ‚çš„ã« forest_4 ã® '>' ã‹ã‚‰ã€Œå±‹æ•·å‰ï¼ˆforest_endï¼‰ã€ã¸ã€‚
    # ============================================================================

    # ----------------------------------------------------------------------------
    # forest_1ï¼šå…¥å£ã€‚å³ä¸‹æ–¹é¢ã« '>' ã§ forest_2 ã¸
    # ----------------------------------------------------------------------------
    "forest_1": {
        "layout": [
            "###################",
            "#..........#......#",
            "#..........#..##..#",
            "#..............#..#",
            "###.####.####..#..#",
            "#.....#......#....#",
            "#.###.#.####.#.##.#",
            "#.#...#....#.#....#",
            "#.#.######.#.####.#",
            "#.#......#.#....#.#",
            "#.######.#.####.#.#",
            "#....>...#........#",  # '>' ã¯ (5,11)
            "#####D#############",
        ],
        "textures": {
            "wall":   "forest_wall.png",
            "floor":  "forest_floor.png",
            "ceiling": None,
            # â˜…ã©ã®ãƒãƒƒãƒ—ã§ã‚‚æ¬ è½ã—ãªã„æ¨™æº–å·®ã—æ›¿ãˆ
            "wall_special": {
                "D": "door_wood.png",
                "X": "sealed_wall.png",
                "O": "forest_trunk.png",
                "F": "forest_fog.png",
            },
        },
        "suggested_player_start": (1.5, 1.5),
        "items": [
            {"id": "map_chart", "kind": "tool", "name": "å¤ã³ãŸåœ°å›³", "pos": (3, 3)},
        ],
        "triggers": [
            {"event": "stair_down", "pos": (5, 11), 
             "target_map": "forest_2", "target_pos": (2, 1),
             "target_face": "E",
             "prompt": "ã“ã®å…ˆã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
        ],
        "doors": [],
    },

    # ----------------------------------------------------------------------------
    # forest_2ï¼šè¢‹å°è·¯å¤šã‚ã€‚'>' ã§ forest_3 ã¸
    # ----------------------------------------------------------------------------
    "forest_2": {
        "layout": [
            "##D################",
            "#.<.........#..GAA#",  # â† (2,1) ã« '<' ã‚’é…ç½®ï¼šforest_1 ã¸ã®æˆ»ã‚Šå£
            "#.####.#.##.#..GAA#",
            "#.#..#.#....#..GGG#",
            "#.#.##.######.#####",
            "#.#....#....#.....#",
            "#.####.#.##.####..#",
            "#....#.#..#....#..#",
            "####.#.##.####.#..#",
            "#....#....#..#.#..#",
            "#.########.#.#.#..#",
            "#..>..............#",  # '>' ã¯ (3,11)
            "###D###############",
        ],
        "textures": {
            "wall":   "forest_wall.png",
            "floor":  "forest_floor.png",
            "ceiling": None,
            "wall_special": {
                "D": "door_wood.png",
                "X": "sealed_wall.png",
                "O": "forest_trunk.png",
                "F": "forest_fog.png",
            },
            "special": {
                "A": "forest_pond_water_tile.png",
                "G": "rock.png",
            },
        },
        "suggested_player_start": (1.5, 1.5),
        "items": [
            {"id": "item_compass",   "kind": "tool",     "name": "æ¢çŸ¥ã®ç¾…é‡ç›¤", "pos": (6, 1)},
            {"id": "axe_001",        "kind": "tool",     "name": "æ–§",           "pos": (17, 1)},
            {"id": "spirit_orb_001", "kind": "offering", "name": "å¹½ãç ",       "pos": (3, 3)},
        ],
        "triggers": [
            {"event": "stair_up",   "pos": (2, 1),  
             "target_map": "forest_1", "target_pos": (5, 11),
             "target_face": "E",
             "prompt": "æ¥ãŸé“ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ"},
            {"event": "stair_down", "pos": (3, 11), 
             "target_map": "forest_3", "target_pos": (2, 1),
             "target_face": "E",
             "prompt": "ã•ã‚‰ã«å¥¥ã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
             
        ],
        "doors": [],
    },

    # ----------------------------------------------------------------------------
    # forest_3ï¼šå®ˆäººï¼‹æ¿ƒéœ§ã€‚'>' ã§ forest_4 ã¸
    # ----------------------------------------------------------------------------
    "forest_3": {
        "layout": [
            "##D################",
            "#.<..#....#....#..#",  # â† (2,1) ã« '<'ï¼šforest_2 ã¸æˆ»ã‚‹
            "####.#.##.#.##.#..#",
            "#..#.#..#.#..#.#..#",
            "#.##.##.#.####.#..#",
            "#..#....#......#..#",
            "##.#.#########.#..#",
            "#..#.#FFFF...#....#",
            "#.##.#FFFF.#..M...#",
            "#....#...###......#",
            "######...##########",
            "#..>..............#",  # '>' ã¯ (3,11)
            "###D###############",
        ],
        "textures": {
            "wall":   "forest_wall.png",
            "floor":  "forest_floor.png",
            "ceiling": None,
            "wall_special": {
                "D": "door_wood.png",
                "X": "sealed_wall.png",
                "O": "forest_trunk.png",
                "F": "forest_fog.png",
            },
        },
        "suggested_player_start": (3.5, 1.5),
        "items": [
            {"id": "key_forest_001", "kind": "key", "name": "éŠ…ã®éµ", "pos": (15, 11)},
        ],
        "triggers": [
            {"event": "stair_up",   "pos": (2, 1),  
             "target_map": "forest_2", "target_pos": (3, 11),
             "target_face": "W",
             "prompt": "æ¥ãŸé“ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ"},
            {"event": "stair_down", "pos": (3, 11), 
             "target_map": "forest_4", "target_pos": (2, 1),
             "target_face": "S",
             "prompt": "ã•ã‚‰ã«å¥¥ã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
        ],
        # å‹•ç”»ã‚‚map.pyã§æŒ‡å®šã™ã‚‹ã¤ã‚‚ã‚Šã§ã—ãŸã€‚
        # "proximity_triggers": [
        #     {
        #         "id": "fog_intro",
        #         "kind": "video",
        #         "symbol_any": ["F", "f"],
        #         "radius_px": 96,
        #         "movie": "assets/movies/fog_block_intro.mp4",
        #         "once_per_map": True,
        #         "cond_flag_not_contains": ["fog_cleared", "forest_4"],
        #     }
        # ],
        "doors": [],
    },

    # ----------------------------------------------------------------------------
    # forest_4ï¼šæ¨ªæ–­ã™ã‚‹å·ï¼‹å€’æœ¨ã§æ©‹ã‚’æ›ã‘ã¦æ¸¡ã‚‹
    # ----------------------------------------------------------------------------
    "forest_4": {
        "layout": [
            "##D################",
            "#.<...............#",
            "#....####....#....#",
            "#....####....#....#",
            "#....####....#....#",
            "#....####O...#....#",
            "#wwwwwwwwwwwwwwwww#",  # â† å¤§æœ¨Oã®å³ã«é€£ç¶šã—ãŸæ°´wï¼ˆå€’æœ¨ã§ã“ã“ãŒBã«ãªã‚‹ï¼‰
            "#....####....#....#",
            "##.#.######.#####.#",
            "####.............>#",  # '>' ã¯ (17,9)
            "#################D#",
            "###################",
            "###################",
        ],
        "textures": {
            "wall":   "forest_wall.png",
            "floor":  "forest_floor.png",
            "ceiling": None,
            "wall_special": {
                "D": "door_wood.png",
                "O": "forest_trunk.png",
                "F": "forest_fog.png",
            },
            "special": {
                "w": "forest_water.png",   # å·ã¯åºŠã¨ã—ã¦æç”»ï¼ˆã§ã‚‚å½“ãŸã‚Šã‚ã‚Šï¼‰
                "B": "bridge_plank.png",   # å€’æœ¨å¾Œã« 'w' â†’ 'B' ã¸ç½®æ›ã—ã¦æ¸¡ã‚Œã‚‹
            },
        },
        "suggested_player_start": (2.5, 1.5),
        # ã“ã®ãƒãƒƒãƒ—ã«å…¥ã£ãŸã‚‰å·ã®ç’°å¢ƒéŸ³ã‚’é³´ã‚‰ã™
        "ambience": {
            "se_loop": "river_loop"  # â† SoundManager å´ã®SEã‚­ãƒ¼
        },
        "triggers": [
            {"event": "stair_up",   "pos": (2, 1),  
             "target_map": "forest_3", "target_pos": (3, 11),
             "target_face": "E",
             "prompt": "æ¥ãŸé“ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ"},
            {"event": "stair_down", "pos": (17, 9), 
             "target_map": "forest_end", "target_pos": (3, 5),
             "target_face": "N",
             "prompt": "å‰ã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
        ],
        "items": [
        # --- é…ç½®ã‚¢ã‚¤ãƒ†ãƒ : ãƒ©ãƒœéµ ---
        # kind/id ã‹ã‚‰å†…éƒ¨ã§ key_lab ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
        {
            "kind": "key",
            "id": "key_lab_001",
            "pos": (2, 8),   # æ‰‹å‰ãƒ‰ã‚¢(7,7)ã‚’æŠœã‘ã¦å°‘ã—é€²ã‚“ã ä½ç½®
            "label": "éŠ€ã®éµ",
            "once": True
        }
    ],
        "doors": [],
    },

    # ============================================================================
    # 2) å±‹æ•·å‰ï¼ˆforest_endï¼‰â†’ å±‹æ•·ï¼ˆlab_entranceï¼‰
    # ============================================================================

    # ----------------------------------------------------------------------------
    # forest_endï¼šå±‹æ•·å‰ã®åº­ï¼ˆå‘¨å›²=æ£®ã€å±‹æ•·ã®å¤–å£ã ã‘å·®ã—æ›¿ãˆï¼‰
    # ----------------------------------------------------------------------------
    "forest_end": {
        "layout": [
            # 19åˆ—Ã—13è¡Œï¼ˆå¤–å‘¨ã¯å£ã§é–‰ã˜ã‚‹ï¼‰
            "###################",
            "#..............HH##", 
            "#....HHHHHH....HH##",
            "#....HHHHHH.......#",
            "#....HHHHHHA......#",  
            "#....HHHHHDA......#",  # â† D (10,5)
            "#....HHHHHHA>.....#",
            "#..<.HHHHHH.......#",
            "#................##",
            "#########........##",
            "###################",
            "###################",
            "###################",
        ],
        "textures": {
            # â˜…å‘¨å›²ã¯æ£®ã®è¦‹ãŸç›®ï¼ˆ'#' ã¯æ£®ã®å£ï¼‰
            "wall":   "forest_wall.png",
            "floor":  "forest_floor.png",
            "ceiling": None,
            # â˜…å±‹æ•·å¤–å£ï¼†ãƒ‰ã‚¢ã ã‘å·®ã—æ›¿ãˆ
            "wall_special": {
                "H": "laboratory_wall.png",  # å±‹æ•·ã®å¤–å£
                "D": "laboratory_door.png",     # ãƒ‰ã‚¢ï¼ˆå£ä¸Šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
            },
            "special": {
                "A": "forest_end_ground.png",

            },
        },
        "suggested_player_start": (3.5, 5.5),
        "triggers": [
            {"event": "stair_up",   
             "pos": (3, 7),  
             "target_map": "forest_4", 
             "target_pos": (17, 9),
             "target_face": "W",
             "prompt": "æ¥ãŸé“ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ"},
            # å±‹æ•·å‰ã®é¢¨è¦‹é¶ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå¾Œã«å±‹æ•·å†…ã¸å†å…¥å ´ï¼‰
            #   - pos ã¯å¾Œã§ '>' ã‚’ç½®ãã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            {
                "event": "stair_down",
                "pos": (12, 6),  # ä¾‹ï¼šãƒ‰ã‚¢å‰ã‚ãŸã‚Šã® '>' ã‚¿ã‚¤ãƒ«
                "target_map": "lab_entrance",
                "target_pos": (3, 8),  # å±‹æ•·å†…ã®ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ï¼ˆå¾Œã§å¾®èª¿æ•´OKï¼‰
                "target_face": "E",
                "prompt": "ç ”ç©¶æ‰€ã®ä¸­ã¸å…¥ã‚Šã¾ã™ã‹ï¼Ÿ",
            },             
        ],   # è¿‘æ¥ãƒ ãƒ¼ãƒ“ãƒ¼â†’è‡ªå‹•ãƒ¯ãƒ¼ãƒ—ã§è¡Œã
        "items": [],
        "doors": [],
    },

# ----------------------------------------------------------------------------
# lab_entranceï¼šç ”ç©¶æ–½è¨­ã®ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ï½ä¸­å¤®å»Šä¸‹ï¼‹2å®¤
#   å³ã®éƒ¨å±‹ï¼šåºŠã‚¹ã‚¤ãƒƒãƒï¼ˆa/b/c/dï¼‰ï¼‹å£ãƒ‘ãƒãƒ«ï¼ˆP/Q/R/Sï¼‰ã®ãƒ‘ã‚ºãƒ«
#   å·¦ã®éƒ¨å±‹ï¼šç ”ç©¶ã‚¨ãƒªã‚¢ï¼ˆè£…ç½®ãƒ»å®Ÿé¨“å°ãªã©ã‚’ä»Šå¾Œé…ç½®äºˆå®šï¼‰
#   åŒ—å´ã®å°é– 'X' ã¯ãƒ‘ã‚ºãƒ«è§£éŒ ã§é–‹æ”¾ã€'<': åœ°ä¸‹ dungeon_1 ã¸ã®ãƒˆãƒªã‚¬ãƒ¼
# ----------------------------------------------------------------------------
"lab_entrance": {
    # 18Ã—18 ã«æ‹¡å¼µã€‚å¤–å‘¨ã¯å£ '#'
    # ä¸­å¤®ã« 2ãƒã‚¹å¹…ã®å»Šä¸‹ï¼ˆx=8..9ï¼‰ãŒå—åŒ—ã«é€šã‚‹ã€‚
    # 7è¡Œç›®ã«å·¦å³ã®éƒ¨å±‹ã¸å…¥ã‚‹ãƒ‰ã‚¢ 'D' ã‚’é…ç½®ï¼ˆå·¦: x=7, å³: x=10ï¼‰ã€‚
    # å³å®¤ã«ã‚¹ã‚¤ãƒƒãƒ a/b/c/dã€å®¤ã®å£ã« P/Q/R/Sï¼ˆç ”ç©¶ç”¨æƒ…å ±ãƒ‘ãƒãƒ«æƒ³å®šï¼‰ã€‚
    "layout": [
        "#########L########",  # y=0
        "########.>########",  # y=1  â† '<' ã¯ (9,1)ï¼šåœ°ä¸‹ dungeon_1 ã¸
        "########..########",  # y=2
        "########XX########",  # y=3  â† 'X' ã¯ãƒ‘ã‚ºãƒ«ã§é–‹æ”¾ï¼ˆ(8,3),(9,3)ï¼‰
        "########..########",  # y=4
        "########..########",  # y=5  â† å³å®¤ åŒ—å£ã« P/Q
        "##.....#..#.....##",  # y=6
        "##.....D..D....aP#",  # y=7  â† å·¦(x=7), å³(x=10) ã«ãƒ‰ã‚¢'D'
        "##.<...#..#.....##",  # y=8
        "##.....#..#....bQ#",  # y=9  â† å³å®¤ã« a,c
        "##.....#..#.....##",  # y=10
        "##.....#..#....cR#",  # y=11
        "##.....#..#.....##",  # y=12
        "##.....#..#....dS#",  # y=13
        "##.....#..#.....##",  # y=14
        "########..########",  # y=15 â† å³å®¤ å—å£ã« R/S
        "########..########",  # y=16
        "##################",  # y=17
    ],

    "textures": {
        # --- ç ”ç©¶æ‰€ã£ã½ã„è¦‹ãŸç›®ã«ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯ä¾‹ã€‚ãŠæ‰‹å…ƒã®ãƒ†ã‚¯ã‚¹ãƒãƒ£åã«åˆã‚ã›ã¦OKï¼‰---
        "wall":    "laboratory_wall.png",      # ç„¡æ©Ÿè³ªãªé‡‘å±/æ¨¹è„‚ãƒ‘ãƒãƒ«å£
        "floor":   "lab_floor_white.png",      # ç™½ç³»ã‚¿ã‚¤ãƒ«
        "ceiling": "lab_ceiling_grid.png",     # ã‚°ãƒªãƒƒãƒ‰å¤©äº•ï¼ˆç…§æ˜ãƒ‘ãƒãƒ«ï¼‰

        # åºŠã‚¹ã‚¤ãƒƒãƒï¼ˆåºŠã‚¿ã‚¤ãƒ«å·®ã—æ›¿ãˆï¼‰
        "special": {
            "a": "switch_floor.png",
            "b": "switch_floor.png",
            "c": "switch_floor.png",
            "d": "switch_floor.png",
            "a_lit": "switch_floor_lit.png",
            "b_lit": "switch_floor_lit.png",
            "c_lit": "switch_floor_lit.png",
            "d_lit": "switch_floor_lit.png",
        },

        # å£ã®å·®ã—æ›¿ãˆï¼šç ”ç©¶æ‰€ã®æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆP/Q/R/Sï¼‰ï¼‹ æ¨™æº–ãƒ‰ã‚¢/å°é–
        "wall_special": {
            # è‚–åƒç”» â†’ æƒ…å ±ãƒ‘ãƒãƒ«ç³»ã«å·®ã—æ›¿ãˆã‚‹æƒ³å®šï¼ˆåç§°ã¯ä¾‹ï¼‰
            "P": "lab_panel_P.png",
            "Q": "lab_panel_Q.png",
            "R": "lab_panel_R.png",
            "S": "lab_panel_S.png",

            "D": "laboratory_door.png",   # ãƒ©ãƒœã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‰ã‚¢
            "X": "sealed_wall.png",  # å°é–å£ï¼ˆéå¸¸å£ã‚·ãƒ£ãƒƒã‚¿ãƒ¼é¢¨ã§ã‚‚OKï¼‰
            "L": "stairs_down_wall_texture1.png",
        },
    },

    # ãƒ‘ã‚ºãƒ«å®šç¾©ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã¯å¾“æ¥ã®â€œè‚–åƒç”»ï¼‹åºŠã‚¹ã‚¤ãƒƒãƒâ€ã‚’æµç”¨ï¼‰
    "puzzle": {
        "id": "lab_switch_order_01",
        # â˜…åº§æ¨™ã¯ layout ã‚’æ­£ç¢ºã«åæ˜ â˜…
        "portraits": {
            # å³å®¤ åŒ—å£ (y=5) ã« P(12,5)/Q(13,5)ã€å—å£ (y=15) ã« R(12,15)/S(13,15)
            # ãã‚Œãã‚Œãƒ‘ãƒãƒ«é¢ã®å‘ãï¼ˆlookï¼‰ã‚’è¨­å®šï¼ˆãƒ’ãƒ³ãƒˆæ¼”å‡ºãªã©ã«åˆ©ç”¨ï¼‰
            "P": {"pos": (16, 7), "look": "S"},
            "Q": {"pos": (16, 9), "look": "S"},
            "R": {"pos": (16,11), "look": "N"},
            "S": {"pos": (16,13), "look": "N"},
        },
        "switches": {
            # å³å®¤ å†…ã®åºŠã‚¹ã‚¤ãƒƒãƒï¼ˆb,d ã‚’ä¸Šæ®µã€a,c ã‚’ä¸‹æ®µã«é…ç½®ï¼‰
            "a": {"pos": (15, 7)},
            "b": {"pos": (15, 9)},
            "c": {"pos": (15, 11)},
            "d": {"pos": (15, 13)},
        },
        # æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯äº’æ›ã®ä¾‹ã€‚å¿…è¦ã«å¿œã˜ã¦ä¸¦ã³æ›¿ãˆå¯
        "answer": ["b", "d", "a", "c"],
        # åŒ—å´å»Šä¸‹ã®å°é– 'X' ã‚’é–‹æ”¾ï¼šlayout ã® (8,3),(9,3)
        "opens": [(8, 3), (9, 3)],
        "hint": "ãƒ‘ãƒãƒ«ã®è¦–ç·šã¨åºŠã®ã—ã‚‹ã—ã‚’èª­ã¿è§£ã‘ã€‚",
        "solved_toast": "ã‚«ã‚·ãƒ£ãƒ³â€¦åŒ—å´ã®å°é–ãŒä¸ŠãŒã£ãŸï¼",
    },

    "triggers": [
        # åœ°ä¸‹ã¸ï¼ˆ'<': (9,1)ï¼‰â€” æ—¢å­˜ã¨åŒæ§˜ stair_up ã‚’ä½¿ç”¨
        {
            "event": "stair_down",
            "pos":   (9, 1),
            "target_map": "dungeon_1",
            "target_pos": (1, 1),
            "target_face": "S", 
            "prompt": "åœ°ä¸‹ã¸é™ã‚Šã¾ã™ã‹ï¼Ÿ",
        },
        # â˜…å±‹æ•·å‰ï¼ˆforest_endï¼‰ã¸æˆ»ã‚‹é¢¨è¦‹é¶
        #   - pos ã¯ ' < ' ã‚’ç½®ãã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã‚‹
        {
            "event": "stair_up",
            "pos": (3, 8),           # â† ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸Šã® '<' ã¯ (3,8)
            "target_map": "forest_end",
            "target_pos": (12, 4),   # forest_end å´ã® '>' ã«å¯¾å¿œ
            "target_face": "S",
            "prompt": "ç ”ç©¶æ‰€ã®å¤–ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ",
        },   
    ],
    "items": [],
    # ãƒ‰ã‚¢
    "doors": [
        # å·¦ã®ãƒ‰ã‚¢ï¼šåº§æ¨™ (7,7)ã€‚key_forest ã‚’ 1 å€‹æ¶ˆè²»ã—ã¦é–‹éŒ  â†’ '.' ã«ç½®æ›
        {
            "id": "lab_west_door",
            "tile": (7, 7),
            "lock_id": "key_forest",   # ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªä¸Šã®éµã‚¿ã‚¤ãƒ—
            "consume": True,           # ä½¿ç”¨å¾Œã« 1 å€‹æ¶ˆè²»
            "open_to": "."             # é–‹éŒ å¾Œã«åºŠã¸ç½®æ›
        },
        # å³ã®ãƒ‰ã‚¢ï¼šåº§æ¨™ (10,7)ã€‚åŒä¸Š
        {
            "id": "lab_east_door",
            "tile": (10, 7),
            "lock_id": "key_lab",
            "consume": True,
            "open_to": "."
        }
    ],
},

    # ============================================================================
    # 3) ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ï¼ˆdungeon_1 â†’ dungeon_2ï¼‰
    #    è¿½è·¡è€…ã«è¿½ã‚ã‚Œã‚‹è¿·è·¯æ§‹æˆã€‚19Ã—13ã§è¢‹å°è·¯ãƒ»ãƒ«ãƒ¼ãƒ—ã‚’æ··åœ¨ã€‚
    #    â€» æ—§ 10Ã—10 ã‹ã‚‰æ‹¡å¼µã€‚æ—¢å­˜ã‚¨ãƒ³ã‚¸ãƒ³ã¯å¯å¤‰ã‚µã‚¤ã‚ºå¯¾å¿œæƒ³å®šã€‚
    # ============================================================================

    # ----------------------------------------------------------------------------
    # dungeon_1ï¼šå°å…¥ãƒ•ãƒ­ã‚¢ã€‚å·¦å¥¥ '<' ã§å±‹æ•·ã¸ã€å³ç«¯ '>' ã§ dungeon_2ã€‚
    # ----------------------------------------------------------------------------
    "dungeon_1": {
        "layout": [
            "###############D###",
            "#<#.#.....#....>.##",
            "#.#.#####.#.##....#",
            "#.#...#.#.#..#...##",
            "#.###.#.#..##...#.#",
            "#.#.#.#.#....#.#..#",
            "#.#.#.#.####.#.#.##",
            "#...#.#....#.#....#",
            "#.###.####.#.####.#",
            "#.....#....#....#.#",
            "#.#####...#..#.#..#",
            "#...........#....##",
            "###################",
        ],
        "no_save": True,  # â† ã“ã®ãƒãƒƒãƒ—ã§ã¯ã‚»ãƒ¼ãƒ–ä¸å¯
        "textures": {
            "wall": "dungeon_wall_1.png",
            "floor": "dangeon_floor_1.png",
            "ceiling": "dangeon_ceiling_1.png",
            "wall_special": {
                "D": "stairs_down_wall_texture2.png",
                "X": "sealed_wall.png",
            },
        },
        "proximity_triggers": [
            {
                "id": "chaser_at_first_corner",
                "kind": "chaser_spawn",      # è¿‘ã¥ã„ãŸã‚‰è¿½è·¡è€…ã‚’å‡ºç¾
                "pos_tile": (1, 6),         
                "radius_tile": 1.5,          # 1.5ã‚¿ã‚¤ãƒ«ä»¥å†…ã«å…¥ã£ãŸã‚‰ç™ºç«
                "movie": "assets/movies/chaser_intro.mp4",   # ä»»æ„ï¼šå°å…¥ãƒ ãƒ¼ãƒ“ãƒ¼
                "toast": "â€¦â€¦å†·ãŸã„æ°—é…ãŒè¿«ã‚‹ã€‚"
            },
            # å¿…è¦ãªã‚‰å¢—ã‚„ã›ã¾ã™ï¼ˆidã¯å¿…ãšä¸€æ„ã«ï¼‰
            # {
            #     "id": "chaser_mid_maze",
            #     "kind": "chaser_spawn",
            #     "pos_tile": (11, 6),
            #     "radius_tile": 1.5,
            #     "toast": "èƒŒå¾Œã«ä½•ã‹â€¦â€¦ï¼Ÿ"
            # },
        ],
        "triggers": [
            {"event": "stair_up",   "pos": (1,1),  
             "target_map": "lab_entrance", 
             "target_pos": (9, 1),
             "target_face": "S",
             "prompt": "åœ°ä¸Šã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ"},
            {"event": "stair_down", "pos": (15, 1), 
             "target_map": "dungeon_2",        
             "target_pos": (2, 1),
             "target_face": "S",
             "prompt": "ã•ã‚‰ã«åœ°ä¸‹æ·±ãã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ"},
        ],
        "items": [],
        "doors": [],
    },

    # ----------------------------------------------------------------------------
    # dungeon_2ï¼šå¥¥ãƒ•ãƒ­ã‚¢ã€‚è¤‡é›‘ãªå›å»Šã€‚å·¦ä¸Š '<' ã§ dungeon_1 ã¸æˆ»ã‚‹ã€‚
    # ----------------------------------------------------------------------------
    "dungeon_2": {
        "layout": [
            "###################",
            "#<.......#.......##",
            "#........#.##.#...#",
            "#.XXXXXX.#..#.#..E#",
            "#.X....X.##.#.#####",
            "#.X....X.#..#...#.#",
            "#.X..XXX.####.###.#",
            "#...........#...#.#",
            "#....#.####.#.###.#",
            "#....#......#.....#",
            "#.######.#..#.....#",
            "#........#........#",
            "###################",
        ],
        "no_save": True,
        "textures": {
            "wall": "dungeon_wall_2.png",
            "floor": "dangeon_floor_2.png",
            "ceiling": "dangeon_ceiling_2.png",
            "wall_special": {
                "D": "door_wood.png",
                "X": "dangeo_lattice.png",
            },
        },
        "suggested_player_start": (2.5, 1.5),

        # â˜… ã“ã“ã‚’ã€Œæ–°ãƒã‚§ã‚¤ã‚µãƒ¼å°‚ç”¨ã®è¨­å®šã€ã«ã™ã‚‹
        "chaser": {
            "spawn": (17, 10),      # æ–°ã‚·ã‚¹ãƒ†ãƒ å´ã§å‚ç…§ï¼ˆåˆæœŸã‚¹ãƒãƒ¼ãƒ³å€™è£œãªã©ï¼‰
            "patrol_hints": [(9, 6), (13, 3), (5, 9)],

            # 2éšå´ã®è¿‘æ¥ãƒˆãƒªã‚¬ï¼ˆå¿…è¦ã«å¿œã˜ã¦ä½ç½®ãªã©èª¿æ•´ï¼‰
            "proximity_triggers": [
                {
                    "id": "chaser_second_floor_intro",
                    "kind": "chaser_spawn",
                    "pos_tile": (1, 6),
                    "radius_tile": 1.5,
                    "movie": "movies/chaser_intro.mp4",
                    "toast": "è¶³éŸ³ãŒâ€¦â€¦è¿‘ã„ã€‚"
                },
            ],
        },

        "triggers": [
            {
                "event": "stair_up",
                "pos": (1, 1),
                "target_map": "dungeon_1",
                "target_pos": (15, 1),
                "target_face": "S",
                "prompt": "ä¸€ã¤ä¸Šã®éšã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ",
            },
        ],
        "items": [],
        "doors": [],
    },

}
